# 反作弊系统设计文档

[TOC]



## 一、项目环境

### 服务端

| 名称           | 操作系统 | 代理服务器     | 数据库       |
| -------------- | -------- | -------------- | ------------ |
| `java` 服务端  | centos   | tomcat         | Redis、Mysql |
| `python`服务端 | Ubuntu   | Nginx+gunicorn | Redis、Mysql |

### 客户端

- PC 版 Chrome 浏览器
- 安卓 App



## 二、项目构建、管理工具和编辑工具

- `Maven`作为项目构建工具
- `Github`作为项目托管平台

- `IDEA`、`Pycharm`、`vscode`作为代码编辑工具



## 三、技术选型

### 后端技术

#### `java` 服务端

> 基于 spring、springMVC 和 Mybatis框架

- `SpringMVC`框架
- `Spring`框架
- `Mybatis`框架

#### `python`服务端

- `Flask`框架
- `Tensorflow`深度学习框架
- `OpenCV`计算机视觉库
- `dilb`计算机视觉库



## 四、模块设计

### 系统整体模块设计

本系统一共七个模块，分别是登陆模块、注册模块、添加学生面部特征模块、学生首页模块、学生考试模块、教师首页模块、教师发布试卷模块和教师查看考试结果模块。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9271xmoxj313o0o4q6l.jpg" alt="image-20200529092339727" style="zoom:67%;" />



### 用户登陆模块

学生和教师统一通过此模块进行登陆，在输入账号和密码时，会进行输入规范检测和是否存在此账号检测，当所有输入无误后会根据用户的角色进行跳转，学生进入学生首页，教师进入教师首页。若为新用户，检测数据库中没有此用户的面部特征，会跳转到面部特征采取模块，进行面部特征的收集。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf92b5cvf6j30m60gydh0.jpg" alt="image-20200529092735849" style="zoom: 67%;" />



### 用户注册模块

用户通过此模块进行注册，注册时输入身份（教师或者学习）、姓名、学号、邮箱、密码和学校。在输入时会进行输入规范性检测，和检测此用户是否已经注册。如果未注册且输入符合规范，则注册成功并跳转登陆界面。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf92nyjru3j30l20gqmy8.jpg" alt="image-20200529093955043" style="zoom:67%;" />



### 面部特征采取模块

此模块用于用户第一次登陆后采取用户的面部特征，调用设备摄像头拍照并上传服务器判断照片是否符合规范，如果合格转为特征数组存到数据库，否则重新拍摄并上传。此特征必须是用户本人，该特征用于学生的作弊检测和其他模块需要验证用户身份的检测，如果该特征不是本人，则会出现学生考试判断作弊和用户验证失败的情况。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf92w0uvxbj30f80gy0tj.jpg" alt="image-20200529094739409" style="zoom:67%;" />



### 学生首页模块

学生登录后进入学生首页模块，此模块会展示学生已经添加未参加的考试。学生可以在此模块中，通过试卷`id`搜索试卷，将其添加到自己的考试中。学生可以在考试前 5 分钟点击相应的考试进入考试页面进行等待，在进入之前会验证安卓应用是否打开，如果打开则进入考试页面，否则不能进入考试页面并提示打开安卓应用，直到学生打开安卓应用后才放行进入考试页面等待。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf93ae79vjj30je0g875i.jpg" alt="image-20200529100128662" style="zoom:67%;" />



### 学生考试模块

学生可提前 5 分钟进去考试页面等待，当到达考试时间，学生可以进行答题。学生题目顺序根据学生`id`进行打乱，保证每个学生题目的顺序不一样。在考试过程中会对学生进行作弊检测，当系统检测到学生有作弊行为，或异常行为到达一个教师设定的一个值之后，会记录其作弊情况，并在考试结果详情页展示。如果学生在考试期间因为设备、网络等不可抗拒因素退出，当学生再次进入考试页面时，系统会自动将学生之前的选项和作答填上，保证学生能够正常考试。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf959w8zpcj30po0igwg7.jpg" alt="image-20200529111010965" style="zoom:67%;" />



### 教师首页模块

教师首页模块会显示教师发布的考试，并可以点击查看考试详情进入查看首页信息，也可以通过点击发布试卷进入发布试卷模块。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf95yctz0zj30go0hijsa.jpg" alt="image-20200529113341972" style="zoom:67%;" />



### 教师发布试卷模块

此模块为教师发布考试，老师在此模块设置考试的相关信息，包括考试时间，考试科目等，同时需要设定学生允许切屏的次数，允许切屏时间。在设置考试信息之后需要添加考试题目。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf987c8j3cj30fk0gswfc.jpg" alt="image-20200529125131939" style="zoom:67%;" />



### 查看考试结果模块

教师通过此模块查看考试各个学生的考试情况，包括学生信息、分数和各个作弊异常情况。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf98adq44cj30cu0iamxv.jpg" alt="image-20200529125426987" style="zoom:67%;" />



## 五、数据库设计

### Mysql数据库

下图为数据库设计图，由 `IDEA`编辑器自动生成。数据库中的表有用户表、用户面部特征表、角色表、学生教师关系表、试卷表、学生试卷关系表、总题目表、选择题表、简答题表、试卷题目表、学生回答简答题表。

![Xnip2020-05-29_10-51-18](https://tva1.sinaimg.cn/large/007S8ZIlly1gf94qyugxpj316w0u0aix.jpg)



#### 用户实体属性图

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf98sf24b0j30us0lywh4.jpg" alt="image-20200529131145045" style="zoom:50%;" />

#### 考试实体属性图

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf98yni1muj30u00mqn00.jpg" alt="image-20200529131746690" style="zoom:50%;" />

#### 选择题实体属性图

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf994bnr3nj30rq0kmabl.jpg" alt="image-20200529132314140" style="zoom:50%;" />

#### 简答题实体属性图

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9954ltl9j30mk0jit9q.jpg" alt="image-20200529132400475" style="zoom:50%;" />

### Redis 数据库

| 名称         | 类型     | key 值                | 说明                                                         | 销毁时间                             |
| ------------ | -------- | --------------------- | ------------------------------------------------------------ | ------------------------------------ |
| 试卷         | `String` | "paper"+试卷 id       | 用于存储试卷信息，当第一次从数据库中查询之后存入 redis 数据库中，之后获取从 redis 中获取。 | 设置定时销毁，当考试结束后自动过期。 |
| 学生选项     | `hash`   | 学生 id+试卷 id       | 用于存储学生在考试期间的选项，如果学生意外退出，再次登录后将其作答填上。 | 学生提交试卷持久化后销毁             |
| 安卓在线状态 | `String` | 学生 id+“PhoneOnline” | 用于存储学生在考试期间安卓应用是否在后台的状态信息。         | 学生提交试卷持久化后销毁             |
| 其他作弊状态 | `String` | 学生 id+作弊英文单词  | 用于存储学生在考试期间检测到的作弊行为的次数和时间等。       | 学生提交试卷持久化后销毁             |



## 六、路由设计

### Java 服务端

| 路由                    | 方法 | 说明                                 | 返回类型             |
| ----------------------- | ---- | ------------------------------------ | -------------------- |
| /user/login             | GET  | web 和安卓用户进行登陆               | 状态码和用户信息     |
| /user/regist            | POST | 用户进行注册                         | 状态码               |
| /user/checkstatus       | GET  | 检测用户是否注册过                   | 状态码               |
| /user/checkOnline       | GET  | 安卓端用于发送应用后台状态           | 状态码               |
| /examInfo               | GET  | 返回一场考试中所有学生的考试结果信息 | 状态码和考试结果信息 |
| /forwardExamInfo        | GET  | 重定向到考试详情页                   | 无                   |
| /examInfoList           | GET  | 返回老师发布的所有考试列表           | 状态码和考试信息列表 |
| /index                  | GET  | 返回学生的考试列表                   | 状态码和考试信息列表 |
| /checkPhotoOnline       | GET  | 检测安卓应用是否在前台               | 状态码               |
| /searchPaper            | GET  | 学生通过试卷 id 搜索试卷             | 状态码和试卷         |
| /addPaper               | GET  | 学生添加这场考试                     | 状态码               |
| /returnExaminationPaper | GET  | 返回考试题目、缓存数据               | 试卷和缓存数据       |
| /saveSelection          | GET  | 将学生的选项保存到缓存               | 状态码               |
| /submitPaper            | POST | 学生提交试卷                         | 状态码               |
| /publishPaper           | POST | 教师发布试卷                         | 状态码               |
| /saveChangeScreen       | GET  | 保存学生切屏次数                     | 状态码               |



### Python 服务端

| 路由         | 方法 | 说明               | 返回类型 |
| ------------ | ---- | ------------------ | -------- |
| /addImage    | POST | 添加学生的面部特征 | 状态码   |
| /checkAction | POST | 检测学生的作弊行为 | 状态码   |



## 七、相关技术实现

### Web 服务端

- #### 题目打乱技术的实现

  试卷的题目是一个数组，通过学生学号`UUID`，将其转换为`hashcode`，然后再将此`hashcode`做为种子生成一个随机数生成器。然后再用集合工具类中的`shuffle`，传入数组和随机生成器将其打乱。这种打乱方式可以保证每个学生的题目顺序不一样，且如果学生意外退出重新进入考试页面时，题目顺序和之前一致。

- #### 解决高频率请求耗资源的情况

  在考试页面，要保证尽可能快速的检测到学生的作弊行为，就需要高频率地向服务器传送学生的照片和判断安卓手机是否处于后台状态。我们在实际的测试中发现通过传统的`TCP`方式向服务器发送请求和接受返回值，在频率很高的情况下是比较耗时、耗资源和带宽，它使用了大量的资源在建立连接和断开连接的过程。所以我们之后使用`webSocket`采用长连接的方式，将一些频繁请求的接口替换成长连接的方式进行传输数据。

### Web客户端

- #### **防切屏设计**

  在防止切屏操作中，如果前端使用页面是否可见visibilitychange事件来监听，将存在以下弊端：

  首先，visibilitychange事件只能在用户最小化窗口或切换到另一个选项卡时才会触发，因此，如果考生在任务栏上切换其他应用时，将出现漏洞。其次，考生可以在考试期间进行分屏操作，此时屏幕将会出现多个窗口时，也同样无法检测。即使采用onblur失去焦点事件，只会当考生在其它窗口内点击之后才触发，如果鼠标在其它窗口上下滑动，将无法检测。

  因此为了能更有效的检测到考生是否出现切屏行为，我们规定，当考生在点击答题按钮之后，就进入全屏模式。此时若是考生退出全屏时间超出老师设置的时间，将视作一次有效切屏。

### 安卓客户端

- #### 判断安卓应用是否处于后台

  这个功能的难点是要检测到用户每一种可能退出程序的方式，其中包括直接利用`home`键或返回键退出、启动后台控制器切换应用或者直接强制推出。最后我们决定利用`activity`或`application`的生命周期进行判断。我们在测试后发现，如果使用`activity`进行后台判断，就需要对应用中所有的`activity`才可以判断整个应用是否处于后台，并且需要结合多个`activity`才能判断用户是否处于后台状态。之后我们又利用了整个应用只有一个的`application`的生命周期对其应用进行是否处于后台的判断，这种方法比利用`activity`判断更加准确，并且逻辑也更加简单。下面引用博客中的介绍：

  > `Android`提供了一种更加方便的方法来监听应用的前后台切换。**使用`ProcessLifecycleOwner`来处理，**`ProcessLifecycleOwner`会监听`application`的状态。这个类就是专门用来监听切后台切换的状态。

  用户在每次进入应用后，和退出应用前都会向服务器发送现在的应用状态，这种方法不用频繁地向服务器发送数据消耗大量的资源，就可以达到检测用户是否处于后台的目的。

- #### 判断安卓应用处于后台的原因是不是由于手机息屏。

  判断手机是否处于黑屏是对于判断安卓应用是否处于后台的进一步完善。在我们的测试中发现，手机自然黑屏也会导致应用处于后台状态并且导致系统错误地判断考生正在使用手机并退出了应用。

  我们之后给出的解决方案是如果用户是因为黑屏导致应用处于后台状态，应用是不会向服务器发送改变用户状态请求，这样就可以保证服务器收到的改变应用后台状态都是由用户主动改变的，提高了识别的准确率。



### 使用摄像头的智能监考

> 从前台抓取回照片的`base64`编码后，解码为`numpy.array`，使用`OpenCV`对图像统一大小，色欲转换以降低计算量

- #### 无人脸超过X 秒，多人同屏超过X 秒

  使用`dlib`库自带`HOG`算法的实现进行初步的人脸检测，得到图像中人脸位置和人脸数量，对于未检测到人脸和人脸数量大于1的情况向前端页面反馈，实现对无人脸和多人同屏的检测；

- #### 中途换人

  在人脸数量为1的条件下进行下一步，从数据库中得到考生的人脸图像编码，与图片中人脸比对  实现对中途换人或者他人替考的检测


- #### 眼神漂移超过X 秒 

  在上一步得到的人脸区域中对人脸使用`dlib`检测脸部的特征点，从特征点中截取眼部区域，使用自己设计的`cnn`对眼神方向识别，通过与阈值比对后返回结果，实现眼神漂移的检测；

在前端根据得到返回结果后，设置一个基于时间的计数器，但计数器达到设定的X秒后，对考生做出相应反馈

### 根据实际使用情况额外增加的两种智能摄像头场景

- #### 笔记本普遍摄像头素质极差，室内环境偏暗，网络条件不允许高分辨率图像传输，眼神方向的检测难以得出高置信度的结果

  通常情况下，视线的离开通常伴随头部方向的轻微改变，借此，通过得到头部的方向，结合眼部的方向给出一个关于眼神漂移的参数，其相较于只对眼睛检测更加靠谱；从传回图片中裁剪出人脸部分，使用`OpenCV`统一大小，色域变换后使用我们自己训练的模型给出头部方向的判断，通过我们在大量现实场景下的实验，设计了一个根据头部方向和眼神方向得出是否有注意力离开的判断算法

- #### 考生使用打印脸部照片和手机屏幕显示照片以绕过以上判断机制

  通过考生近24次脸部图像，设计一个对时间敏感的3D卷积网络，判断考生是否使用打印照片或者屏幕欺骗。 
  
  

## 八、参考资料

1. 安卓切换后台参考博客[网站](https://juejin.im/post/5c8b32555188251bde6be3ce)，代码位置于类注释标注

2. 安卓黑屏检测参考博客[网站](https://blog.csdn.net/fantasy_lin_/article/details/83276325)，代码位置于类注释标注

3. 安卓图标来自阿里矢量图标库[网站](https://www.iconfont.cn/)

4. java 跨域问题参考博客[网站](https://segmentfault.com/a/1190000019551860)，代码位置于类注释标注

5. HTML5前端调用摄像头[网址](https://segmentfault.com/q/1010000015666526)

6. 登录、注册、首页背景[图片](https://www.ciucacristi.tk/login/style4/images/bg.svg)

7. 人脸识别算法 face_recognition[网址](https://github.com/ageitgey/face_recognition)

8. 活体检测预训练模型[网址](https://github.com/AhmetHamzaEmra/Intelegent_Lock/blob/master/model/model.h5)

9. 头部方向模型数据集`CUbiC FacePix Database`[网址](https://cubic.asu.edu/content/facepix-database)

10. 眼神方向模型数据集`Columbia Gaze Data Set`[网址](https://www.cs.columbia.edu/CAVE/databases/columbia_gaze/)

    

    

