# Netty 高性能架构设计

### 线程模型基本介绍

1. 目前存在的线程模型有：
   - 传统阻塞 I/O 服务模型
   - Reactor 模式
2. 根据`Reactor`的数量和处理资源池线程的数量不同，有 3 种典型的实现
   - 单`Reactor`单线程
   - 单`Reactor`多线程
   - 主从`Reactor`多线程
3. Netty 线程模式，Netty 主要基于主从`Reactor`多线程模型做了一定的改进，其中主从`Reactor`多线程模型有多个`Reactor`。



### 传统阻塞 I/O 服务模型

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghdf52e01nj30sg0p81b0.jpg" alt="image-20200803103427511" style="zoom:67%;" />

#### 模型特点

1. 采用阻塞 I/O 模式获取输入的数据
2. 每个连接都需要独立的线程完成数据的输入、业务处理和数据返回

#### 问题分析

1. 当并发数很大，就会创建大量的线程，占用很大的系统资源
2. 连接创建后，如果当前线程暂时没有数据可读，该线程会阻塞在 read 操作，造成线程资源浪费。



### Reactor 模式

#### 针对传统阻塞 I/O 服务模型的两个缺点，解决方案：

1. 基于 I/O 复用模型：多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象等待，无需阻塞等待所有连 接。当某个连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理 Reactor 对应的叫法: 1. 反应器模式 2. 分发者模式(Dispatcher) 3. 通知者模式(notifier)。
2. 基于线程池复用线程资源：不必再为每个连接创建线程，将连接完成后的业务处理任务分配给线程进行处理， 一个线程可以处理多个连接的业务。

![image-20200803104505831](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghdfg5ftn8j30x00awqdz.jpg)

> ServiceHandler 负责阻塞，其他线程无需阻塞。当ServiceHandler状态改变需要读写时，将任务分发给工作线程。



#### I/O 复用结合线程池，就是 Reactor 模式基本设计思想，如图

![image-20200803105013373](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghdflgxheej31440pgnlr.jpg)

